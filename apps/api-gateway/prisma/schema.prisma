// Prisma Schema for Cloud Governance Copilot
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// Tenants (Multi-tenancy)
// ============================================================
model Tenant {
  id               String   @id @default(uuid()) @map("tenant_id") @db.Uuid
  name             String   @db.VarChar(255)
  slug             String   @unique @db.VarChar(100)
  planType         String   @map("plan_type") @db.VarChar(50)
  status           String   @default("active") @db.VarChar(50)
  settings         Json     @default("{}")
  maxUsers         Int      @default(5) @map("max_users")
  maxCloudAccounts Int      @default(3) @map("max_cloud_accounts")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  users                       User[]
  cloudAccounts               CloudAccount[]
  apiKeys                     ApiKey[]
  auditLogs                   AuditLog[]
  billingUsage                BillingUsage[]
  subscriptions               Subscription[]
  assets                      Asset[]
  costData                    CostData[]
  costAnomalies               CostAnomaly[]
  costRecommendations         CostRecommendation[]
  securityScans               SecurityScan[]
  securityFindings            SecurityFinding[]
  azureSecurityScores         AzureSecurityScore[]
  incidents                   Incident[]
  reports                     Report[]
  logAnalyticsQueries         LogAnalyticsQuery[]
  azureAdvisorRecommendations AzureAdvisorRecommendation[]

  @@map("tenants")
}

// ============================================================
// Users
// ============================================================
model User {
  id           String    @id @default(uuid()) @map("user_id") @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  fullName     String?   @map("full_name") @db.VarChar(255)
  role         String    @db.VarChar(50)
  status       String    @default("active") @db.VarChar(50)
  avatarUrl    String?   @map("avatar_url")
  lastLogin    DateTime? @map("last_login") @db.Timestamptz(6)
  preferences  Json      @default("{}") @db.Json

  // Email Verification
  emailVerified            Boolean   @default(false) @map("email_verified")
  emailVerificationToken   String?   @map("email_verification_token") @db.VarChar(255)
  emailVerificationExpires DateTime? @map("email_verification_expires") @db.Timestamptz(6)

  // Multi-Factor Authentication (MFA)
  mfaEnabled     Boolean @default(false) @map("mfa_enabled")
  mfaSecret      String? @map("mfa_secret") @db.Text // Encrypted TOTP secret
  mfaBackupCodes Json?   @map("mfa_backup_codes") @db.Json // Array of hashed backup codes

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  apiKeys        ApiKey[]
  auditLogs      AuditLog[]
  advisorActions AdvisorAction[]

  @@index([tenantId])
  @@index([email])
  @@index([emailVerificationToken])
  @@map("users")
}

// ============================================================
// Cloud Accounts
// ============================================================
model CloudAccount {
  id                String @id @default(uuid()) @map("account_id") @db.Uuid
  tenantId          String @map("tenant_id") @db.Uuid
  provider          String @db.VarChar(50) // aws, azure, gcp
  accountName       String @map("account_name") @db.VarChar(255)
  accountIdentifier String @map("account_identifier") @db.VarChar(255)

  // Encrypted credentials (AES-256-GCM)
  // Stored as JSON with structure: { accessKey: {...}, secretKey: {...}, ... }
  // Each credential contains: { ciphertext, iv, authTag }
  credentialsCiphertext String @map("credentials_ciphertext") @db.Text
  credentialsIv         String @map("credentials_iv") @db.VarChar(255)
  credentialsAuthTag    String @map("credentials_auth_tag") @db.VarChar(255)

  status    String    @default("active") @db.VarChar(50)
  lastSync  DateTime? @map("last_sync") @db.Timestamptz(6)
  metadata  Json      @default("{}") @db.Json
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assets        Asset[]
  costData      CostData[]
  securityScans SecurityScan[]

  @@unique([tenantId, provider, accountIdentifier])
  @@index([tenantId])
  @@index([provider])
  // Performance indexes for Azure account queries
  @@index([tenantId, provider, status]) // Active accounts by provider
  @@index([status]) // All active accounts (filter in query)
  @@map("cloud_accounts")
}

// ============================================================
// API Keys
// ============================================================
model ApiKey {
  id        String    @id @default(uuid()) @map("key_id") @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  keyName   String    @map("key_name") @db.VarChar(255)
  keyHash   String    @map("key_hash") @db.VarChar(255)
  keyPrefix String    @map("key_prefix") @db.VarChar(20)
  scopes    Json      @default("[]") @db.Json
  lastUsed  DateTime? @map("last_used") @db.Timestamptz(6)
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("api_keys")
}

// ============================================================
// Audit Logs
// ============================================================
model AuditLog {
  id           String   @id @default(uuid()) @map("log_id") @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  userId       String?  @map("user_id") @db.Uuid
  action       String   @db.VarChar(100)
  resourceType String?  @map("resource_type") @db.VarChar(100)
  resourceId   String?  @map("resource_id") @db.Uuid
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  userAgent    String?  @map("user_agent")
  metadata     Json     @default("{}") @db.Json
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([createdAt(sort: Desc)])
  // Performance indexes for Azure audit queries
  @@index([tenantId, resourceType, createdAt(sort: Desc)]) // Resource-specific audit trails
  @@index([action]) // Action-based filtering
  @@map("audit_logs")
}

// ============================================================
// Billing Usage
// ============================================================
model BillingUsage {
  id            String   @id @default(uuid()) @map("usage_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  usageType     String   @map("usage_type") @db.VarChar(100)
  quantity      Decimal  @default(0) @db.Decimal(15, 4)
  unit          String   @db.VarChar(50)
  cost          Decimal? @default(0) @db.Decimal(10, 2)
  billingPeriod DateTime @map("billing_period") @db.Date
  metadata      Json     @default("{}") @db.Json
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([billingPeriod])
  @@map("billing_usage")
}

// ============================================================
// Subscriptions (Stripe)
// ============================================================
model Subscription {
  id                   String    @id @default(uuid()) @map("subscription_id") @db.Uuid
  tenantId             String    @map("tenant_id") @db.Uuid
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id") @db.VarChar(255)
  stripeCustomerId     String?   @map("stripe_customer_id") @db.VarChar(255)
  planType             String    @map("plan_type") @db.VarChar(50)
  status               String    @db.VarChar(50)
  currentPeriodStart   DateTime? @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd     DateTime? @map("current_period_end") @db.Timestamptz(6)
  cancelAt             DateTime? @map("cancel_at") @db.Timestamptz(6)
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// ============================================================
// SHARED DOMAIN: Assets (Used by all modules)
// ============================================================
model Asset {
  id             String @id @default(uuid()) @map("asset_id") @db.Uuid
  tenantId       String @map("tenant_id") @db.Uuid
  cloudAccountId String @map("cloud_account_id") @db.Uuid

  // Multi-cloud support
  provider     String  @db.VarChar(50) // "aws" | "azure" | "gcp"
  resourceType String  @map("resource_type") @db.VarChar(100) // "ec2_instance" | "azure_vm" | "rds_instance"
  resourceId   String  @map("resource_id") @db.VarChar(500) // i-123456, /subscriptions/...
  arn          String? @db.VarChar(500) // AWS ARN
  resourceUri  String? @map("resource_uri") @db.VarChar(1000) // Azure Resource URI

  // Metadata
  name   String? @db.VarChar(255)
  region String  @db.VarChar(100)
  zone   String? @db.VarChar(100)
  status String  @db.VarChar(50) // "running" | "stopped" | "terminated"

  tags     Json @default("{}") @db.Json
  metadata Json @default("{}") @db.Json // Provider-specific data

  // Enhanced asset management fields
  lastDiscovered DateTime? @map("last_discovered") @db.Timestamptz(6) // Last successful discovery
  isOrphaned     Boolean   @default(false) @map("is_orphaned") // Resources without owner tag or stopped
  costLast30Days Decimal?  @map("cost_last_30_days") @db.Decimal(10, 2) // Cost allocation
  ownerTag       String?   @map("owner_tag") @db.VarChar(255) // Tag-based ownership
  environmentTag String?   @map("environment_tag") @db.VarChar(50) // prod, dev, staging
  projectTag     String?   @map("project_tag") @db.VarChar(255) // Project identifier

  // Discovery tracking
  firstSeenAt DateTime  @default(now()) @map("first_seen_at") @db.Timestamptz(6)
  lastSeenAt  DateTime  @default(now()) @map("last_seen_at") @db.Timestamptz(6)
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6) // Soft delete for orphan detection

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cloudAccount     CloudAccount      @relation(fields: [cloudAccountId], references: [id], onDelete: Cascade)
  costData         CostData[]
  securityFindings SecurityFinding[]

  @@unique([tenantId, provider, resourceId])
  @@index([tenantId])
  @@index([cloudAccountId])
  @@index([provider, resourceType])
  @@index([lastSeenAt]) // For orphan detection
  // Performance indexes for Azure resource queries
  @@index([tenantId, resourceType]) // Resource type filtering
  @@index([tenantId, resourceType, status]) // ARCHITECT RECOMMENDATION: Optimized asset queries
  @@index([tenantId, region]) // Location-based queries
  @@index([tenantId, provider, status]) // Provider-specific active resources
  // Enhanced asset management indexes
  @@index([tenantId, isOrphaned]) // Orphaned resources query
  @@index([tenantId, ownerTag]) // Owner-based filtering
  @@index([tenantId, environmentTag]) // Environment-based filtering
  @@index([tenantId, projectTag]) // Project-based filtering
  @@index([lastDiscovered]) // Discovery tracking
  @@map("assets")
}

// ============================================================
// MODULE: FINOPS (Cloud Spend Navigator)
// ============================================================
model CostData {
  id             String  @id @default(uuid()) @map("cost_id") @db.Uuid
  tenantId       String  @map("tenant_id") @db.Uuid
  cloudAccountId String  @map("cloud_account_id") @db.Uuid
  assetId        String? @map("asset_id") @db.Uuid

  // Multi-cloud cost data
  date     DateTime @db.Date
  amount   Decimal  @db.Decimal(12, 4)
  currency String   @default("USD") @db.VarChar(10)

  provider  String  @db.VarChar(50) // "aws" | "azure"
  service   String  @db.VarChar(100) // "EC2" | "Virtual Machines" | "RDS"
  usageType String? @map("usage_type") @db.VarChar(200) // "Instance hours" | "GB-month"
  operation String? @db.VarChar(200)

  tags     Json @default("{}") @db.Json
  metadata Json @default("{}") @db.Json // Provider-specific data

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cloudAccount CloudAccount @relation(fields: [cloudAccountId], references: [id], onDelete: Cascade)
  asset        Asset?       @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@unique([tenantId, cloudAccountId, date, provider, service, usageType])
  @@index([tenantId])
  @@index([cloudAccountId])
  @@index([assetId])
  @@index([date]) // CRITICAL for time-series queries
  @@index([provider, service])
  // Performance indexes for Azure cost queries
  @@index([tenantId, date(sort: Desc)]) // Time-series cost queries (dashboards)
  @@index([tenantId, provider, service]) // Service breakdown by provider
  @@index([tenantId, date(sort: Desc), provider]) // Multi-cloud cost comparison
  @@index([amount(sort: Desc)]) // Cost ranking queries (filter in query)
  @@map("cost_data")
}

model CostAnomaly {
  id       String @id @default(uuid()) @map("anomaly_id") @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  detectedAt DateTime @default(now()) @map("detected_at") @db.Timestamptz(6)
  date       DateTime @db.Date

  severity String @db.VarChar(20) // "low" | "medium" | "high" | "critical"
  status   String @default("open") @db.VarChar(50) // "open" | "investigating" | "resolved"

  provider   String  @db.VarChar(50) // "aws" | "azure"
  service    String? @db.VarChar(100)
  resourceId String? @map("resource_id") @db.VarChar(500)

  expectedCost Decimal @map("expected_cost") @db.Decimal(12, 4)
  actualCost   Decimal @map("actual_cost") @db.Decimal(12, 4)
  deviation    Decimal @db.Decimal(5, 2) // Percentage

  rootCause Json? @map("root_cause") @db.Json // AI-generated analysis (Phase 2)

  resolvedAt DateTime? @map("resolved_at") @db.Timestamptz(6)
  resolvedBy String?   @map("resolved_by") @db.Uuid

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([date])
  @@index([provider])
  // Performance indexes for Azure anomaly queries
  @@index([tenantId, status, severity]) // Active anomalies by severity
  @@index([tenantId, detectedAt(sort: Desc)]) // Recent anomaly detection
  @@index([tenantId, provider, status]) // Provider-specific anomaly tracking
  @@map("cost_anomalies")
}

model CostRecommendation {
  id       String @id @default(uuid()) @map("recommendation_id") @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  type     String @db.VarChar(100) // "rightsizing" | "unused_resource" | "reserved_instance"
  priority String @db.VarChar(20) // "high" | "medium" | "low"

  provider   String  @db.VarChar(50) // "aws" | "azure"
  service    String  @db.VarChar(100)
  resourceId String? @map("resource_id") @db.VarChar(500)

  title       String @db.VarChar(255)
  description String @db.Text

  estimatedSavings Decimal @map("estimated_savings") @db.Decimal(10, 2)
  savingsPeriod    String  @map("savings_period") @db.VarChar(20) // "monthly" | "yearly"

  status String @default("open") @db.VarChar(50) // "open" | "applied" | "dismissed"

  actionable   Boolean @default(false) // Can be auto-applied?
  actionScript String? @map("action_script") @db.Text

  metadata  Json      @default("{}") @db.Json
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  appliedAt DateTime? @map("applied_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([priority])
  @@index([provider])
  // Performance indexes for Azure recommendation queries
  @@index([tenantId, status, priority(sort: Desc)]) // Active recommendations by priority
  @@index([tenantId, provider, status]) // Provider-specific recommendations
  @@index([estimatedSavings(sort: Desc)]) // Top savings opportunities (filter in query)
  @@map("cost_recommendations")
}

// ============================================================
// MODULE: SECURITY (Security Misconfig Scanner)
// ============================================================
model SecurityScan {
  id             String @id @default(uuid()) @map("scan_id") @db.Uuid
  tenantId       String @map("tenant_id") @db.Uuid
  cloudAccountId String @map("cloud_account_id") @db.Uuid

  provider  String   @db.VarChar(50) // "aws" | "azure"
  scanType  String   @map("scan_type") @db.VarChar(50) // "full" | "compliance" | "quick"
  framework String[] @db.VarChar(50) // ["CIS", "NIST"]

  startedAt   DateTime  @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  status      String    @db.VarChar(50) // "running" | "completed" | "failed"

  findingsCount Int @default(0) @map("findings_count")
  criticalCount Int @default(0) @map("critical_count")
  highCount     Int @default(0) @map("high_count")
  mediumCount   Int @default(0) @map("medium_count")
  lowCount      Int @default(0) @map("low_count")

  error String? @db.Text

  // Relations
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cloudAccount CloudAccount      @relation(fields: [cloudAccountId], references: [id], onDelete: Cascade)
  findings     SecurityFinding[]

  @@index([tenantId])
  @@index([cloudAccountId])
  @@index([provider])
  @@index([startedAt])
  // Performance indexes for Azure security scan queries
  @@index([tenantId, provider, startedAt(sort: Desc)]) // Provider-specific scan history
  @@map("security_scans")
}

model SecurityFinding {
  id       String  @id @default(uuid()) @map("finding_id") @db.Uuid
  tenantId String  @map("tenant_id") @db.Uuid
  scanId   String  @map("scan_id") @db.Uuid
  assetId  String? @map("asset_id") @db.Uuid

  ruleCode  String @map("rule_code") @db.VarChar(100) // "CIS-1.1" | "NIST-AC-2"
  framework String @db.VarChar(50) // "CIS" | "NIST"

  severity String @db.VarChar(20) // "critical" | "high" | "medium" | "low"
  status   String @default("open") @db.VarChar(50) // "open" | "resolved" | "dismissed"

  provider     String @db.VarChar(50) // "aws" | "azure"
  resourceType String @map("resource_type") @db.VarChar(100)

  title       String @db.VarChar(500)
  description String @db.Text
  remediation String @db.Text

  evidence Json? @db.Json

  detectedAt DateTime  @default(now()) @map("detected_at") @db.Timestamptz(6)
  resolvedAt DateTime? @map("resolved_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  scan   SecurityScan @relation(fields: [scanId], references: [id], onDelete: Cascade)
  asset  Asset?       @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([scanId])
  @@index([assetId])
  @@index([severity, status])
  @@index([provider])
  // Performance indexes for Azure security queries
  @@index([tenantId, provider, status, severity]) // Multi-filter security dashboards
  @@index([tenantId, severity, status]) // ARCHITECT RECOMMENDATION: Optimized security dashboard queries
  @@map("security_findings")
}

// Azure Security Scores - Historical security posture tracking
model AzureSecurityScore {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  subscriptionId String   @map("subscription_id") @db.VarChar(255)
  scoreType      String   @map("score_type") @db.VarChar(50) // "overall" | "network" | "compute" | "data" | "identity"
  currentScore   Float    @map("current_score")
  maxScore       Float    @map("max_score")
  percentage     Float // Calculated: currentScore / maxScore
  scoredAt       DateTime @map("scored_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([tenantId, scoreType, scoredAt(sort: Desc)]) // Latest scores by type
  @@index([scoredAt(sort: Desc)]) // Time-series queries
  @@map("azure_security_scores")
}

// ============================================================
// MODULE: INCIDENTS (Incident IQ) - Phase 2
// ============================================================
model Incident {
  id       String @id @default(uuid()) @map("incident_id") @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  title       String  @db.VarChar(500)
  description String? @db.Text

  severity String @db.VarChar(20) // "critical" | "high" | "medium" | "low"
  status   String @default("open") @db.VarChar(50) // "open" | "investigating" | "resolved"

  source   String  @db.VarChar(50) // "manual" | "alert" | "ai" | "cost_anomaly"
  sourceId String? @map("source_id") @db.Uuid

  assignedTo String? @map("assigned_to") @db.Uuid

  relatedAssets   Json @default("[]") @map("related_assets") @db.Json
  relatedCosts    Json @default("[]") @map("related_costs") @db.Json
  relatedFindings Json @default("[]") @map("related_findings") @db.Json

  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  resolvedAt DateTime? @map("resolved_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([severity])
  @@map("incidents")
}

// ============================================================
// MODULE: ADVISOR (Advisor Report) - Phase 2
// ============================================================
model Report {
  id       String @id @default(uuid()) @map("report_id") @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid

  reportType  String   @map("report_type") @db.VarChar(100) // "executive" | "cost" | "security"
  generatedAt DateTime @default(now()) @map("generated_at") @db.Timestamptz(6)

  data   Json    @db.Json
  pdfUrl String? @map("pdf_url") @db.VarChar(500)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([generatedAt])
  @@map("reports")
}

// ============================================================
// MODULE: LOG ANALYTICS (KQL Query Management)
// ============================================================
model LogAnalyticsQuery {
  id          String  @id @default(uuid()) @db.Uuid
  tenantId    String  @map("tenant_id") @db.Uuid
  accountId   String  @map("account_id") @db.VarChar(255)
  name        String  @db.VarChar(255)
  query       String  @db.Text
  description String? @db.Text
  createdBy   String? @map("created_by") @db.VarChar(255)

  lastExecuted   DateTime? @map("last_executed") @db.Timestamptz(6)
  executionCount Int       @default(0) @map("execution_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, accountId, name])
  @@index([tenantId, accountId])
  @@index([lastExecuted(sort: Desc)])
  @@map("log_analytics_queries")
}

// ============================================================
// MODULE: AZURE ADVISOR (Recommendations Management)
// ============================================================
model AzureAdvisorRecommendation {
  id                    String @id @default(uuid()) @map("recommendation_id") @db.Uuid
  tenantId              String @map("tenant_id") @db.Uuid
  azureRecommendationId String @map("azure_recommendation_id") @db.VarChar(500)

  // Recommendation metadata
  category         String  @db.VarChar(50) // Cost, Security, Reliability, Performance, OperationalExcellence
  impact           String  @db.VarChar(20) // High, Medium, Low
  shortDescription String  @map("short_description") @db.Text
  longDescription  String? @map("long_description") @db.Text

  // Resource information
  resourceId   String  @map("resource_id") @db.VarChar(500)
  resourceType String? @map("resource_type") @db.VarChar(100)

  // Savings information (for Cost recommendations)
  potentialSavingsAmount   Decimal? @map("potential_savings_amount") @db.Decimal(10, 2)
  potentialSavingsCurrency String?  @map("potential_savings_currency") @db.VarChar(10)

  // Remediation
  remediationSteps Json @map("remediation_steps") @db.Json // Array of strings

  // Status tracking
  status          String    @default("Active") @db.VarChar(50) // Active, Suppressed, Dismissed, Resolved
  suppressedUntil DateTime? @map("suppressed_until") @db.Timestamptz(6)

  // Timestamps
  lastUpdated DateTime @default(now()) @map("last_updated") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actions AdvisorAction[]

  @@unique([tenantId, azureRecommendationId], name: "tenantId_azureRecommendationId")
  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, status])
  @@index([tenantId, impact])
  @@index([category, status])
  @@map("azure_advisor_recommendations")
}

model AdvisorAction {
  id               String @id @default(uuid()) @map("action_id") @db.Uuid
  recommendationId String @map("recommendation_id") @db.Uuid
  userId           String @map("user_id") @db.Uuid

  // Action details
  actionType   String  @map("action_type") @db.VarChar(50) // suppress, dismiss, apply, resolve
  durationDays Int?    @map("duration_days") // For suppress actions
  notes        String? @db.Text

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  recommendation AzureAdvisorRecommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)
  user           User                       @relation(fields: [userId], references: [id])

  @@index([recommendationId])
  @@index([userId])
  @@index([actionType])
  @@index([createdAt(sort: Desc)])
  @@map("advisor_actions")
}
