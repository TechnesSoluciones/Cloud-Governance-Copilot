###################################################################################
# Docker Compose - Development/Staging Environment
# Cloud Governance Copilot
###################################################################################
# This is optimized for rapid development with:
# - Hot reload enabled
# - Separated services for easy debugging
# - Volume mounts for live code changes
# - Enhanced logging
###################################################################################

networks:
  copilot-dev:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

services:
  #
  # Redis - Cache and Session Store
  #
  redis:
    image: redis:7-alpine
    container_name: copilot-redis-dev
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-dev_redis_pass}
    ports:
      - "6379:6379"
    networks:
      copilot-dev:
        ipv4_address: 172.20.0.10
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    environment:
      - TZ=America/Caracas

  #
  # PostgreSQL - Primary Database (if you want local DB for dev)
  # Comment out if using remote DB server
  #
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: copilot-postgres-dev
  #   restart: unless-stopped
  #   ports:
  #     - "5432:5432"
  #   networks:
  #     copilot-dev:
  #       ipv4_address: 172.20.0.11
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   environment:
  #     - POSTGRES_USER=${DB_USER:-copilot}
  #     - POSTGRES_PASSWORD=${DB_PASSWORD:-copilot_dev_pass}
  #     - POSTGRES_DB=${DB_NAME:-copilot_main}
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U copilot"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  #
  # API Gateway - Backend Services
  #
  api-gateway:
    build:
      context: ./apps/api-gateway
      dockerfile: Dockerfile
      target: development
    container_name: copilot-api-dev
    restart: unless-stopped
    ports:
      - "3010:3010"
      - "9229:9229"  # Node debugger
    networks:
      copilot-dev:
        ipv4_address: 172.20.0.20
    env_file:
      - .env.development
    environment:
      - NODE_ENV=development
      - PORT=3010
      - REDIS_URL=redis://:${REDIS_PASSWORD:-dev_redis_pass}@172.20.0.10:6379
      - LOG_LEVEL=debug
    volumes:
      # Mount source code for hot reload
      - ./apps/api-gateway/src:/app/src:delegated
      - ./apps/api-gateway/package.json:/app/package.json
      # Exclude node_modules to avoid conflicts
      - /app/node_modules
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3010/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    command: npm run dev

  #
  # Frontend - Next.js Development Server
  # ISOLATED FOR EASY DEBUGGING
  #
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile.dev  # Separate dev Dockerfile
      target: development
    container_name: copilot-frontend-dev
    restart: unless-stopped
    ports:
      - "3000:3000"  # Next.js app
      - "9230:9230"  # Node debugger (different port than backend)
    networks:
      copilot-dev:
        ipv4_address: 172.20.0.30
    env_file:
      - .env.development
    environment:
      - NODE_ENV=development
      - PORT=3000
      - NEXT_PUBLIC_API_URL=http://localhost:3010
      - INTERNAL_API_URL=http://172.20.0.20:3010
      - WATCHPACK_POLLING=true  # For file watching in Docker
      - CHOKIDAR_USEPOLLING=true
    volumes:
      # Mount source for hot reload
      - ./apps/frontend:/app:delegated
      # Exclude these to avoid conflicts
      - /app/node_modules
      - /app/.next
    depends_on:
      api-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Dev server with fast refresh
    command: npm run dev -- --turbo

volumes:
  redis-data:
    driver: local
  # postgres-data:
  #   driver: local
